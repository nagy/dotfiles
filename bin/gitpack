#!/usr/bin/env bash
set -euxo pipefail
gitpack_1() {
    (
        cd -- "$1"
        size=$(( $(du --summarize|cut --fields=1) / 1024))
        GITPACK_MAX_SIZE=${GITPACK_MAX_SIZE:-100}
        GITPACK_MAX_FILES=${GITPACK_MAX_FILES:-100}
        if [ $size -lt "$GITPACK_MAX_SIZE" ];then
            files=$(find . |wc --lines)
            if [ "$files" -gt "$GITPACK_MAX_FILES" ];then
                du -sh
                git -c gc.reflogExpire=0 \
                    -c gc.reflogExpireUnreachable=0 \
                    -c gc.rerereresolved=0 \
                    -c gc.rerereunresolved=0 \
                    -c gc.pruneExpire=now \
                    gc --aggressive
                du -sh
            fi
        fi
    )
}

for var in "$@"; do
    gitpack_1 $var
done
